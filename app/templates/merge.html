{% extends "base.html" %}
{% block title %}PPT合并处理 - 金蝶{% endblock %}
{% block content %}
<div class="card">
  <h1>PPT合并处理</h1>
  <p class="subtitle">本模块用于验证：通过各种条件找到多个原子 PPT，并在这里合并到统一模板中导出。</p>

  <form id="mergeForm">
    <div class="field">
      <label for="template">1) 上传模板 PPT (.pptx，可选)</label>
      <input id="template" name="template" type="file" accept=".pptx" />
      <div style="margin-top: 6px; color:#64748b; font-size:13px;">优先使用本次上传模板；未上传时自动使用“方案库管理”中的统一模板。</div>
    </div>

    <div class="field">
      <label for="sources">2) 上传多个内容 PPT (.pptx)</label>
      <input
        id="sources"
        name="sources"
        type="file"
        accept=".pptx"
        multiple
        required
      />
    </div>

    <button type="submit">开始处理并下载</button>
  </form>

  <div id="status" style="margin-top: 12px; white-space: pre-wrap;"></div>
  <div class="feature-note" style="margin-top: 18px; border: 1px dashed #cbd5e1; border-radius: 10px; padding: 12px; background: #f8fafc; color: #475569; font-size: 14px;">
    可从左侧导航进入「PPT搜索填入」，自动联网检索并新增2页分析内容。
  </div>
</div>

<script>
  const form = document.getElementById("mergeForm");
  const status = document.getElementById("status");

  function parseTemplateSource(source) {
    if (source === "upload") return "上传模板";
    if (source === "unified_db") return "统一模板";
    return "未知";
  }

  form.addEventListener("submit", async (event) => {
    event.preventDefault();
    status.textContent = "处理中，请稍候...";

    const formData = new FormData();
    const template = document.getElementById("template").files[0];
    const sourceFiles = document.getElementById("sources").files;

    if (template) {
      formData.append("template", template);
    }
    for (const file of sourceFiles) {
      formData.append("sources", file);
    }

    try {
      const resp = await fetch("/merge", {
        method: "POST",
        body: formData,
      });

      if (!resp.ok) {
        const message = await resp.text();
        throw new Error(message || "处理失败");
      }

      const blob = await resp.blob();
      const imported = resp.headers.get("X-Merge-Imported-Slides");
      const adjusted = resp.headers.get("X-Merge-Adjusted-Slides");
      const templateSource = parseTemplateSource(resp.headers.get("X-Template-Source"));

      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.href = url;
      link.download = resp.headers.get("Content-Disposition")?.split("filename=")[1]?.replaceAll('"', "") || "merged.pptx";
      link.click();
      URL.revokeObjectURL(url);

      status.textContent = `完成: 共导入 ${imported || "?"} 页，布局调整 ${adjusted || "?"} 页。模板来源：${templateSource}`;
    } catch (error) {
      status.textContent = `失败: ${error.message}`;
    }
  });
</script>
{% endblock %}
